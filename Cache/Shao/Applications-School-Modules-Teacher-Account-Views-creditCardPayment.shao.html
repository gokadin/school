<form id="subscription-credit-card-form" action="/School/school/teacher/account/subscription/payment/credit-card" method="POST">
    <div class="create-form-body">

        <span class="payment-errors"></span>

        <input type="hidden" name="subscriptionType" value="<?php echo  $subscription->type ; ?>" />

        <div class="row create-form-input-row subscription-description-row">
            <div class="col-md-3 create-form-label"><b>Subscription</b></div>
            <div class="col-md-9"><?php echo  $subscription->name().'&nbsp;&nbsp;&nbsp;'.$subscription->defaultRate().' / month' ; ?></div>
        </div>

        <div class="row create-form-input-row">
            <div class="col-md-3 create-form-label">Card number<span class="required">*</span></div>
            <div class="col-md-9 create-form-input">
                <div class="input-icon">
                    <i class="fa fa-warning"></i>
                    <input type="text" class="form-control" id="cardNumber" data-stripe="number" placeholder="Card Number" />
                </div>
                <span class="input-message">Card number is required.</span>
                <span class="input-message">Must be numeric.</span>
            </div>
        </div>

        <div class="row create-form-input-row">
            <div class="col-md-3 create-form-label">Expires<span class="required">*</span></div>
            <div class="col-md-9 create-form-input">
                <select id="expirationMonth" class="form-control" data-stripe="exp-month">
                    <option value="0">---</option>
                    <?php for ($i = 1; $i < 13; $i++) { ?>
                        <?php if ($i < 10) { ?>
                            <option value="0<?php echo  $i ; ?>">0<?php echo  $i ; ?></option>
                        <?php } else { ?>
                            <option value="<?php echo  $i ; ?>"><?php echo  $i ; ?></option>       
                        <?php } ?>
                    <?php } ?>
                </select>
                <select id="expirationYear" class="form-control" data-stripe="exp-year">
                    <option value="0">---</option>
                    <?php for ($i = 15; $i < 46; $i++) { ?>
                        <option value="20<?php echo  $i ; ?>">20<?php echo  $i ; ?></option>
                    <?php } ?>
                </select>
            </div>
        </div>

        <div class="row create-form-input-row">
            <div class="col-md-3 create-form-label">Card code<span class="required">*</span></div>
            <div class="col-md-3 create-form-input">
                <div class="input-icon">
                    <i class="fa fa-warning"></i>
                    <input type="text" class="form-control" id="cardCode" data-stripe="cvc" placeholder="CVC" />
                </div>
                <span class="input-message">Card code is required.</span>
                <span class="input-message">Must be numeric.</span>
                <span class="input-message">Must be 3 digits long.</span>
            </div>
        </div>

    </div>
    <div class="create-form-footer">
        <div class="col-md-7"></div>
        <div class="col-md-5">
            <a href="/School/school/teacher/account/subscription"><button id="credit-card-payment-cancel-button" class="btn btn-default" type="button">Cancel</button></a>
            <button id="credit-card-payment-submit-button" class="btn btn-success" type="submit">Subscribe</button>
        </div>
    </div>
</form>

<script type="text/javascript">
var waitingDialog = (function ($) {

// Creating modal dialog's DOM
var $dialog = $(
	'<div class="modal fade" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog" aria-hidden="true" style="padding-top:15%; overflow-y:visible;">' +
	'<div class="modal-dialog modal-m">' +
	'<div class="modal-content">' +
		'<div class="modal-header"><h3 style="margin:0;"></h3></div>' +
		'<div class="modal-body">' +
			'<div class="progress progress-striped active" style="margin-bottom:0;"><div class="progress-bar" style="width: 100%"></div></div>' +
		'</div>' +
	'</div></div></div>');

return {
	/**
	 * Opens our dialog
	 * @param message Custom message
	 * @param options Custom options:
	 * 				  options.dialogSize - bootstrap postfix for dialog size, e.g. "sm", "m";
	 * 				  options.progressType - bootstrap postfix for progress bar type, e.g. "success", "warning".
	 */
	show: function (message, options) {
		// Assigning defaults
		var settings = $.extend({
			dialogSize: 'sm',
			progressType: ''
		}, options);
		if (typeof message === 'undefined') {
			message = 'Loading';
		}
		if (typeof options === 'undefined') {
			options = {};
		}
		// Configuring dialog
		$dialog.find('.modal-dialog').attr('class', 'modal-dialog').addClass('modal-' + settings.dialogSize);
		$dialog.find('.progress-bar').attr('class', 'progress-bar');
		if (settings.progressType) {
			$dialog.find('.progress-bar').addClass('progress-bar-' + settings.progressType);
		}
		$dialog.find('h3').text(message);
		// Opening dialog
		$dialog.modal();
	},

	hide: function () {
		$dialog.modal('hide');
	}
}
})(jQuery);
</script>

<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
    
<script type="text/javascript" src="/School/Applications/School/Modules/Teacher/Account/Views/js/validateCreditCardPayment.js"></script>
    
<script type="text/javascript">
Stripe.setPublishableKey('pk_test_TYrTrbmk26Ycou9fkd7U81Ol');

var stripeResponseHandler = function(status, response) {
    waitingDialog.hide();
    
    var $form = $('#subscription-credit-card-form');
    
    if (response.error) {
        $form.find('.payment-errors').text(response.error.message);
        $form.find('button').prop('disabled', false);
    } else {
        var token = response.id;
        
        $form.append($('<input type="hidden" name="stripeToken" />').val(token));
        $form.get(0).submit();
    }
};

jQuery(function($) {
    $('#subscription-credit-card-form').submit(function(e) {
        waitingDialog.show();
        
        var $form = $(this);

        $form.find('button').prop('disabled', true);
        
        Stripe.card.createToken($form, stripeResponseHandler);

        return false;
    });
});
</script> 