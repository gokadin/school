@inject('\Library\Facades\Form')
@inject('\Library\Facades\Sentry')

@layout('school.layout')

@section('content')

<link rel="stylesheet" href="{{ asset('css/specific/messaging.css') }}" type="text/css" />
<link rel="stylesheet" href="{{ asset('css/specific/messagingResponsive.css') }}" type="text/css" />

<div id="messaging-index">
    {{ Form::open('', 'POST', ['v-on' => 'submit: submitForm', 'id' => 'new-message-form'], false) }}

    <div class="form-row">
        <select id="student-ids" class="js-example-basic-multiple form-control" multiple="multiple">
            @foreach ($students as $student)
            <option value="{{ $student->id }}" data-picture="{{ $student->profile_picture }}">{{ $student->name() }}</option>
            @endforeach
        </select>
    </div>

    <div class="form-row">
        {{ Form::textarea('content', null, ['v-model' => 'newMessage.content']) }}
        {{ Form::button('Send', ['type' => 'submit', 'class' => 'btn btn-primary']) }}
    </div>

    {{ Form::close() }}

    <hr>

    <div id="messaging-user-rows">

        <div class="messaging-user-row" v-repeat="conversation: conversations">

            <div class="col-md-12 messaging-user-info" v-class="open: conversation.show" v-on="click: revealMessages(conversation)">
                <span id="messaging-user-rows-picture">
                    <img src="@{{ conversation.otherUsers.length == 1 ? conversation.otherUsers[0].profile_picture : test }}" height="60" width="auto" />
                </span>
                <span id="messaging-user-rows-name">
                    @{{ conversation.otherUsers[0].name }}
                </span>
                <span id="messaging-user-rows-delete">
                    <a v-on="click: showDeleteConfirmationModal(conversation)">
                        <img src="{{ asset('images/icons/delete-conversation.png') }}" width="30" height="30" />
                    </a>
                </span>
            </div>

            <div class="col-md-12 messaging-user-messages" v-if="conversation.show" v-transition="expand">
                <div class="col-md-12 messaging-user-messages-inner-container">
                    <div class="col-md-12" v-repeat="message: conversation.messages">
                        <div class="user-messaging-message-inner-container" v-class="is-outgoing: (message.from_id == currentId && message.from_type == currentType)">
                            <div class="messaging-user-title">
                                <b>@{{ getMessageUserName(conversation, message) }}</b> - @{{ message.created_at | formatDateForMessage }}
                            </div>
                            <div class="messaging-user-message">
                                @{{ message.content }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-12 messaging-user-new-message">
                    <hr>

                    {{ Form::open('', 'POST', ['v-on' => 'submit: submitFormWithUser($event, conversation)'], false) }}

                    {{ Form::text('content', null, ['v-model' => 'conversation.new_message_content', 'class' => 'new-message-input']) }}
                    {{ Form::button('Send', ['type' => 'submit', 'class' => 'new-message-button']) }}

                    {{ Form::close() }}
                </div>
            </div>

        </div>

    </div>

    <div class="modal fade" id="confirm-delete-modal" tabindex="-1" role="dialog">
        {{ Form::hidden('user_id', '', ['id' => 'confirm-delete-modal-user-id']) }}
        {{ Form::hidden('user_type', '', ['id' => 'confirm-delete-modal-user-type']) }}
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    Confirm delete
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this conversation?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-danger" v-on="click: deleteConversation()">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<link rel="stylesheet" type="text/css" href="{{ asset('css/select2.min.css') }}">
<script type="text/javascript" src="{{ asset('js/select2.min.js') }}"></script>
<script src="http://cdn.jsdelivr.net/vue/0.12.9/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue-resource/0.1.10/vue-resource.min.js"></script>
<script src="{{ asset('js/socket.io.js') }}"></script>

<script type="text/javascript">
    $('#student-ids').select2({
        placeholder: "Select students",
        templateResult: formatStudent
    });

    function formatStudent (student) {
        var $student = $(
                '<span><img src="' + $(student.element).data("picture") + '" width="20" /> ' + student.text + '</span>'
        );
        return $student;
    }

    function scrollDownMessages() {
        var scrollables = document.getElementsByClassName('messaging-user-messages-inner-container');
        for (var i = 0; i < scrollables.length; i++) {
            scrollables[i].scrollTop = scrollables[i].scrollHeight;
        }
    }

    Vue.http.headers.common['CSRF-TOKEN'] = $('#csrf-token').attr('content');

    function buildPhpDateTime(value) {
        var year = value.getFullYear();
        var month = value.getMonth() + 1;
        var day = value.getDate();
        var hour = value.getHours();
        var minute = value.getMinutes();
        var second = value.getSeconds();

        return year + '-' + month + '-' + day + ' ' + hour + ':' + minute + ':' + second;
    }

    Vue.transition('expand', {
        enter: function () {
            scrollDownMessages();
        }
    })

    var test = new Vue({
        el: '#messaging-index',

        data: {
            newMessage: {
                content: '',
                to_id: '',
                to_type: ''
            },

            conversations: JSON.parse('{{ $conversationsJson }}'),

            currentUserName: '{{ Sentry::user()->name() }}',
            currentId: '{{ Sentry::id() }}',
            currentType: '{{ Sentry::type() }}'
        },

        ready: function() {
            if (this.conversations.length > 0) {
                this.conversations[0].show = true;
            }

            var socket = io('http://localhost:3000');

            socket.on('messaging.newMessageReceived', function(payload) {
                var payload = JSON.parse(payload);

                test.receiveNewMessage(payload);
            });
        },

        filters: {
            formatDateForMessage: function(value) {
                if (!value) {
                    return value;
                }

                var dateAndTime = value.split(' ');
                var dateOnly = dateAndTime[0].split('-');
                var timeOnly = dateAndTime[1].split(':');

                var date = new Date(dateOnly[0],
                        (parseInt(dateOnly[1]) - 1),
                        dateOnly[2],
                        timeOnly[0],
                        timeOnly[1],
                        timeOnly[2]);
                var now = new Date();
                var delta = new Date(now - date);

                var hours = date.getHours();
                var minutes = date.getMinutes();

                if (hours < 10) {
                    hours = '0' + hours.toString();
                }
                if (minutes < 10) {
                    minutes = '0' + minutes.toString();
                }

                var dateString = hours + ':' + minutes;
                if (delta < 86400000) {
                    return dateString;
                }

                dateString = getMonthName(date.getMonth() + 1, true) + ' ' + date.getDate() + ' ' + dateString;
                if (delta < 1892160000000) {
                    return dateString;
                }

                return date.getFullYear() + ' ' + dateString;

                return delta;
            }
        },

        methods: {
            receiveNewMessage: function(payload) {
                var conversationIndex = -1;
                for (var i = 0; i < this.conversations.length; i++) {
                    if (this.conversations[i].id == payload.conversation_id) {
                        conversationIndex = i;
                        break;
                    }
                }

                if (conversationIndex == -1) {
                    return;
                }

                if (payload.from_id == this.currentId && payload.from_type == this.currentType) {
                    return;
                }

                this.conversations[conversationIndex].messages.push({
                    conversation_id: payload.conversation_id,
                    from_id: payload.from_id,
                    from_type: payload.from_type,
                    content: payload.content,
                    created_at: buildPhpDateTime(new Date())
                });

                Vue.nextTick(function() {
                    scrollDownMessages();
                });
            },

            showDeleteConfirmationModal: function(userMessage) {
                $('#confirm-delete-modal-user-id').val(userMessage.id);
                $('#confirm-delete-modal-user-type').val(userMessage.user_type);
                $('#confirm-delete-modal').modal('show');
            },

            deleteConversation: function() {
                var user_id = $('#confirm-delete-modal-user-id').val();
                var user_type = $('#confirm-delete-modal-user-type').val();

                this.userMessages.forEach(function(userMessage, index, userMessages) {
                    if (userMessage.id == user_id && userMessage.user_type == user_type) {
                        userMessages.$remove(index);
                        return false;
                    }
                });

                this.$http.delete('/school/messaging/ajax/destroyConversation', {user_id: user_id, user_type: user_type});

                $('#confirm-delete-modal').modal('hide');
            },

            revealMessages: function(conversation) {
                if (conversation.show) {
                    conversation.show = false;
                    return;
                }

                $.each(this.conversations, function(value) {
                    value.show = false;
                });

                conversation.show = true;
            },

            submitForm: function(e) {
                e.preventDefault();

                var message = this.newMessage;
                message.to_id = $('#student-ids').select2('val')[0];
                message.to_type = 'Student';
                this.newMessage = {content: '', to_id: '', to_type: ''};

                this.$http.post('/school/messaging/ajax/store', message);
            },

            submitFormWithUser: function(e, conversation) {
                e.preventDefault();

                if (conversation.new_message_content == '') {
                    return;
                }

                var newMessage = {
                    conversation_id: conversation.id,
                    content: conversation.new_message_content
                };

                conversation.new_message_content = '';

                conversation.messages.push({
                    conversation_id: conversation.id,
                    from_id: this.currentId,
                    from_type: this.currentType,
                    content: newMessage.content,
                    created_at: buildPhpDateTime(new Date())
                });

                this.$http.post('/school/messaging/ajax/store', newMessage);

                Vue.nextTick(function() {
                    scrollDownMessages();
                });
            },

            getMessageUserName: function(conversation, message) {
                var result = 'unknown';

                if (message.from_id == this.currentId && message.from_type == this.currentType) {
                    return this.currentUserName;
                }

                $.each(conversation.otherUsers, function(key, value) {
                    if (value.id == message.from_id && value.type == message.from_type) {
                        result = value.name;
                        return false;
                    }
                });

                return result;
            }
        }
    });

    function getMonthName(number, isShort) {
        switch (number) {
            case 1:
                return isShort ? 'Jan' : 'January';
            case 2:
                return isShort ? 'Feb' : 'February';
            case 3:
                return isShort ? 'Mar' : 'March';
            case 4:
                return isShort ? 'Apr' : 'April';
            case 5:
                return isShort ? 'May' : 'May';
            case 6:
                return isShort ? 'Jun' : 'June';
            case 7:
                return isShort ? 'Jul' : 'July';
            case 8:
                return isShort ? 'Aug' : 'August';
            case 9:
                return isShort ? 'Sept' : 'September';
            case 10:
                return isShort ? 'Oct' : 'October';
            case 11:
                return isShort ? 'Nov' : 'November';
            case 12:
                return isShort ? 'Dec' : 'December';
        }
    }
</script>

@stop()